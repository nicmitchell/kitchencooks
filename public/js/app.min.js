var fb = new Firebase('https://hrr-kitchen-legacy.firebaseio.com/');
var fbSeating = new Firebase('https://hrr-kitchen-legacy.firebaseio.com/seating');
var fbChats = new Firebase('https://hrr-kitchen-legacy.firebaseio.com/chats');
var fbHangouts = new Firebase('https://hrr-kitchen-legacy.firebaseio.com/hangouts');

// var fbSeating = new Firebase('https://hrr-kitchen-legacy.firebaseio.com/seating');

/* App Module */

var kitchenApp = angular.module('kitchenApp', [
  'ui.bootstrap',
  'ngRoute',
  'appControllers',
  'kitchenApp.services',
  'firebase'
  ],
  function($interpolateProvider) {
    $interpolateProvider.startSymbol('{%');
    $interpolateProvider.endSymbol('%}');
  }
)
.config(['$routeProvider',
  function($routeProvider) {
    $routeProvider.
      when('/index', {
        templateUrl: '/partials/kitchenView.html',
        controller: 'kitchenCtrl'
      }).
      when('/admin', {
        templateUrl: '/partials/adminView.html',
        controller: 'adminCtrl'
      }).
      otherwise({
        redirectTo: '/index'
      });
  }]);
window.userName = 'Loading';

// var fbHangouts = new Firebase('https://hrr-kitchen-legacy.firebaseio.com/hangouts');
// if so then provide the user with the hangout url

var appControllers = angular.module('appControllers', ['ngCookies', 'firebase']);


//this controller handles the kitchen view and designates which seats are available
//It uses functions stored in tableHelpers.js
appControllers.controller('kitchenCtrl', ['$scope', '$cookies', '$firebase', 'TableHelpers', 'topicsStorage',
  function ($scope, $cookies, $firebase, TableHelpers, topicsStorage) {

    var user  = {};
    var ref = new Firebase('https://hrr-kitchen-legacy.firebaseio.com/seating');
    var sync = $firebase(ref);

    // if ref points to a data collection
    $scope.seats = sync.$asArray();
    $scope.seatsObj = sync.$asObject();
    console.log('seats', $scope.seats);

    if ($cookies.user) {
      window.userName = $cookies.user;
    } else {
      window.userName = "Anonymous";
    }

    $scope.satDown = false;
    $scope.currentSeat = "standing";
    $scope.hangouts = {};
    $scope.example = [1,2,3,4,5];

    // Services
    $scope.handleClick = TableHelpers.handleClick;
    $scope.clearRoom = function(){
      $scope.seats = TableHelpers.clearRoom();
      // console.log('seating from callback', seating);
      // $scope.seats = seating;
    };

    $scope.doClick = function(seat, table, $event) {
      $scope.handleClick(seat, table, $event, $scope);
    };

    $scope.selectedSeat = false;

    // Gets the inital values from Firebase and updates the local seating data
    fbSeating.once("value", function(snapshot) {
      $scope.$apply(function(){
        $scope.seats = snapshot.val();
        console.log('fbSeating on value', $scope.seats);
        fbSeating.set($scope.seats);
      });
      $scope.selectedSeat = true;
    });

    $scope.topic = topicsStorage.getTodayTopic;

  }]

);

appControllers.factory('topicsStorage', function(){
  var fbTopics = new Firebase('https://hrr-kitchen-legacy.firebaseio.com/topics');
  var fbTopic = new Firebase('https://hrr-kitchen-legacy.firebaseio.com/topic');

  var topics = [
      {text: "Why do you hate CoffeeScript?"},
      {text: "Which one is your favourate framework?"},
      {text: "Why do you join Hack Reactor"}
    ];

  var todayTopic = "Why do you join Hack Reactor?";

  return {
    getTopics: function(){
      fbTopics.on('child_added', function(snapshot) {
        var topic = snapshot.val();
        topics.push(topic);
      });
      return topics;
    },
    addTopics: function(topic){
      fbTopics.push({text: topic});
      // topics.push(topic);
    },
    getTodayTopic: function(){
      fbTopic.on('child_changed', function(snapshot) {
        todayTopic = snapshot.val();
      });
      return todayTopic;
    },
    setTodayTopic: function(topic){
      fbTopic.set({topic: topic});
      // todayTopic = topic;
    }
  };
});

appControllers.controller('adminCtrl', ['$scope', 'topicsStorage', function($scope, topicsStorage){

  $scope.topics = topicsStorage.getTopics();

  $scope.saveTopic = function(){
    topicsStorage.addTopics($scope.newTopic);
    // $scope.topics.push($scope.newTopic);
    $scope.newTopic = '';
  };

  $scope.setTopic = function(topic){
    topicsStorage.setTodayTopic(topic);
  };

  $scope.topic = topicsStorage.getTodayTopic;

  $scope.init = function(){
    topicsStorage.getTopics();
  };

}]);

angular.module('kitchenApp.services', [])

.factory('TableHelpers', function($firebase){
  var startOrJoinVideo = function(seat, table, $scope){

    // var table = $scope.hangouts[seat.tableNumber];
    // var table = $scope.seats[seat.tableNumber];

    console.log('scope.seats',$scope.seats);

    //This funcitons is in videoConderence/videoFaces.js
    //It will generate a room based on the table number
    joinThumbVideos(table);

    // I don't think this is being used any more without appear.in
    // if (table.users === 0){

    //   table.users++;

    //   //modal alert box
    //   bootbox.alert("Creating a video group chat! Allow the kitchen app to access your camera.");
    //   $(".modal-backdrop").css("z-index", "0");

    //   //updates model and view with the new seating arrangment
    //   // $scope.$apply(function(){
    //     console.log('SEAT', seat, table);
    //     $scope.currentURL = table.url;
    //     $scope.currentSeat = seat.tableNumber + ' - ' + seat.seatNumber;
    //   // });

    //   //call function to start video and store link to it here
    //   //should probably be changed so that it is called when "OK" is clicked on the bootbox modal
    //   // window.open('https://appear.in/hrr-kitchen-'+ seat.tableNumber);

    //   //updates the firebase
    //   // fbHangouts.set($scope.hangouts);

    // }else{

      // window.open('https://appear.in/hrr-kitchen-'+ seat.tableNumber);

      //modal alert box
      bootbox.alert('Joining a video chat! Allow the kitchen app to access your camera.');
      $(".modal-backdrop").css("z-index", "0");

      //updates model and view with the new seating arrangment
      // $scope.$apply(function(){
        // $scope.currentURL = table.url;
        // $scope.currentSeat = seat.tableNumber + ' - ' + seat.seatNumber;
      // });

      // fbHangouts.set($scope.hangouts);

    // }

  };

  //This functions decides the outcome when a user clicks on a seat
  var handleClick = function(seat, table, $event, $scope) {
    console.log('handleClick seat', seat);
    // if($event){
    //     $event.preventDefault();
    // }
    // var seats = $scope.seats.$asObject();
    // console.log('seats on click', $scope.seats[0]);
    // console.log('seats on click', seats);

    var ref = new Firebase('https://hrr-kitchen-legacy.firebaseio.com/seating');
    var sync = $firebase(ref);

    // if ref points to a data collection
    // table = table.slice(-1);
    console.log('seats on click', $scope.seatsObj);
    console.log('table', table);
    // console.log('seats', $scope.seats.table);

    seat = $scope.seatsObj[table][seat];

    if (!$scope || !$scope.satDown){

      if (seat && !seat.taken){
        console.log('seat', seat);

        $scope.currentSeat = seat.seatNumber;

        // seat.name = userName;
        // seat.avatar = avatar || '';
        // seat.taken = true;
        $scope.satDown = true;

        fbSeating.child(table).child(seat.seatNumber).set({ taken: true, name: userName, avatar: avatar, seatNumber: seat.seatNumber, tableNumber: table });

        //calls above function
        startOrJoinVideo(seat, table, $scope);

      }else{
        //modal alert
        console.log('name', $scope.seatsObj[table]);
        bootbox.alert("Seat already occupied");
        $(".modal-backdrop").css("z-index", "0");

      }

    }else{

      if (seat.name === userName){

        seat.name = 'empty';
        seat.taken = false;
        $scope.satDown = false;

        $scope.currentSeat = "standing";
        $scope.currentURL = "No current hangout url";

        //updates firebase
        fbSeating.set($scope.seats);

        var table = $scope.seats[seat.tableNumber];

        table.users--;

        $scope.currentSeat = 'Standing';

      }else{
        //modal alert
        bootbox.alert("You're already sat down");
        $(".modal-backdrop").css("z-index", "0");

      }
    }
  };

  // This function clears the seats of all users by setting the firebase database to all empty seats
  // It is called when the clear room button is clicked
  // It has been implemented to aid development but probably should not be included in the final product
  var clearRoom = function($scope){
    // console.log('scope in clear room', $scope.seats);


    var hangouts = {
      "table1" : {
        "users": 0,
        "message": 0,
        "url": 0
      },
      "table2" : {
        "users": 0,
        "message": 0,
        "url": 0
      },
      "table3" : {
        "users": 0,
        "message": 0,
        "url": 0
      },
      "table4" : {
        "users": 0,
        "message": 0,
        "url": 0
      },
      "table5" : {
        "users": 0,
        "message": 0,
        "url": 0
      },
      "table6" : {
        "users": 0,
        "message": 0,
        "url": 0
      }
    };

    var seating = {
      "table1" : {
        "seat1" : {
          "name" : "empty",
          "seatNumber" : "seat1",
          "tableNumber" : "table1",
          "taken" : false
        },
        "seat2" : {
          "name" : "empty",
          "seatNumber" : "seat2",
          "tableNumber" : "table1",
          "taken" : false
        },
        "seat3" : {
          "name" : "empty",
          "seatNumber" : "seat3",
          "tableNumber" : "table1",
          "taken" : false
        },
        "seat4" : {
          "name" : "empty",
          "seatNumber" : "seat4",
          "tableNumber" : "table1",
          "taken" : false
        },
        "tableNumber" : "table1"
      },
      "table2" : {
        "seat1" : {
          "name" : "empty",
          "seatNumber" : "seat1",
          "tableNumber" : "table2",
          "taken" : false
        },
        "seat2" : {
          "name" : "empty",
          "seatNumber" : "seat2",
          "tableNumber" : "table2",
          "taken" : false
        },
        "seat3" : {
          "name" : "empty",
          "seatNumber" : "seat3",
          "tableNumber" : "table2",
          "taken" : false
        },
        "seat4" : {
          "name" : "empty",
          "seatNumber" : "seat4",
          "tableNumber" : "table2",
          "taken" : false
        },
        "tableNumber" : "table2"
      },
      "table3" : {
        "seat1" : {
          "name" : "empty",
          "seatNumber" : "seat1",
          "tableNumber" : "table3",
          "taken" : false
        },
        "seat2" : {
          "name" : "empty",
          "seatNumber" : "seat2",
          "tableNumber" : "table3",
          "taken" : false
        },
        "seat3" : {
          "name" : "empty",
          "seatNumber" : "seat3",
          "tableNumber" : "table3",
          "taken" : false
        },
        "seat4" : {
          "name" : "empty",
          "seatNumber" : "seat4",
          "tableNumber" : "table3",
          "taken" : false
        },
        "tableNumber" : "table3"
      },
      "table4" : {
        "seat1" : {
          "name" : "empty",
          "seatNumber" : "seat1",
          "tableNumber" : "table4",
          "taken" : false
        },
        "seat2" : {
          "name" : "empty",
          "seatNumber" : "seat2",
          "tableNumber" : "table4",
          "taken" : false
        },
        "seat3" : {
          "name" : "empty",
          "seatNumber" : "seat3",
          "tableNumber" : "table4",
          "taken" : false
        },
        "seat4" : {
          "name" : "empty",
          "seatNumber" : "seat4",
          "tableNumber" : "table4",
          "taken" : false
        },
        "tableNumber" : "table4"
      },
      "table5" : {
        "seat1" : {
          "name" : "empty",
          "seatNumber" : "seat1",
          "tableNumber" : "table5",
          "taken" : false
        },
        "seat2" : {
          "name" : "empty",
          "seatNumber" : "seat2",
          "tableNumber" : "table5",
          "taken" : false
        },
        "seat3" : {
          "name" : "empty",
          "seatNumber" : "seat3",
          "tableNumber" : "table5",
          "taken" : false
        },
        "seat4" : {
          "name" : "empty",
          "seatNumber" : "seat4",
          "tableNumber" : "table5",
          "taken" : false
        },
        "tableNumber" : "table5"
      },
      "table6" : {
        "seat1" : {
          "name" : "empty",
          "seatNumber" : "seat1",
          "tableNumber" : "table6",
          "taken" : false
        },
        "seat2" : {
          "name" : "empty",
          "seatNumber" : "seat2",
          "tableNumber" : "table6",
          "taken" : false
        },
        "seat3" : {
          "name" : "empty",
          "seatNumber" : "seat3",
          "tableNumber" : "table6",
          "taken" : false
        },
        "seat4" : {
          "name" : "empty",
          "seatNumber" : "seat4",
          "tableNumber" : "table6",
          "taken" : false
        },
        "tableNumber" : "table6"
      }
    };

    fbHangouts.set(hangouts);
    return fbSeating.set(seating, function($scope){
      console.log('room cleared');
      return seating;
    });
  };

  return {
    startOrJoinVideo: startOrJoinVideo,
    handleClick: handleClick,
    clearRoom: clearRoom
  };
});
